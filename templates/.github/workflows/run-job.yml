name: Run Mantis AI Job

on:
  create:

jobs:
  run-agent:
    runs-on: ${{ vars.RUNS_ON || 'ubuntu-latest' }}
    if: github.ref_type == 'branch' && startsWith(github.ref_name, 'job/')
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          sparse-checkout: |
            package-lock.json
            .mantis-local
          sparse-checkout-cone-mode: false

      - name: Check for local execution marker
        id: local-check
        run: |
          if [ -f .mantis-local ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Job is running locally â€” skipping GitHub Actions execution."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Get mantis-ai version
        if: steps.local-check.outputs.skip != 'true'
        id: version
        run: |
          VERSION=$(jq -r '.packages["node_modules/mantis-ai"].version // "latest"' package-lock.json)
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        if: steps.local-check.outputs.skip != 'true' && startsWith(vars.JOB_IMAGE_URL, 'ghcr.io/')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Mantis AI Agent
        if: steps.local-check.outputs.skip != 'true'
        env:
          ALL_SECRETS: ${{ toJson(secrets) }}
          JOB_IMAGE_URL: ${{ vars.JOB_IMAGE_URL }}
          MANTIS_VERSION: ${{ steps.version.outputs.tag }}
          LLM_MODEL: ${{ vars.LLM_MODEL }}
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL }}
        run: |
          if [ -n "$JOB_IMAGE_URL" ]; then
            IMAGE="${JOB_IMAGE_URL}:latest"
          else
            IMAGE="maitrikpatel2025/mantis-ai:job-${MANTIS_VERSION}"
          fi
          echo "Using image: $IMAGE"

          # Build SECRETS JSON from AGENT_* (excluding AGENT_LLM_*) secrets
          export SECRETS=$(echo "$ALL_SECRETS" | jq -c '
            [to_entries[] | select(.key | startswith("AGENT_")) | select(.key | startswith("AGENT_LLM_") | not)]
            | map({key: (.key | sub("^AGENT_"; "")), value: .value}) | from_entries')

          # Build LLM_SECRETS JSON from AGENT_LLM_* secrets
          export LLM_SECRETS=$(echo "$ALL_SECRETS" | jq -c '
            [to_entries[] | select(.key | startswith("AGENT_LLM_"))]
            | map({key: (.key | sub("^AGENT_LLM_"; "")), value: .value}) | from_entries')

          docker run --rm \
            -e REPO_URL="${{ github.server_url }}/${{ github.repository }}.git" \
            -e BRANCH="${{ github.ref_name }}" \
            -e SECRETS \
            -e LLM_SECRETS \
            -e LLM_MODEL="${LLM_MODEL}" \
            -e LLM_PROVIDER="${LLM_PROVIDER}" \
            -e OPENAI_BASE_URL="${OPENAI_BASE_URL}" \
            "$IMAGE"
